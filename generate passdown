import React from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useEffect } from 'react';
import Sidebar from '../components/navigation/Sidebar';
import TechnicianDetail from '../components/technicians/TechnicianDetail';
import IntegrativeBayMap from '../components/dashboard/IntegrativeBayMap';
import PassdownReportModal from '../components/dashboard/PassdownReportModal';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';
import { Button } from '@/components/ui/button';
import { FileText } from 'lucide-react';

export default function Dashboard() {
  const [selectedTechnician, setSelectedTechnician] = React.useState(null);
  const [processFilter, setProcessFilter] = React.useState('disassembling');
  const [showPassdownModal, setShowPassdownModal] = React.useState(false);
  const queryClient = useQueryClient();
  const navigate = useNavigate();

  const { data: vehicles = [], isLoading: vehiclesLoading } = useQuery({
    queryKey: ['vehicles'],
    queryFn: () => base44.entities.Vehicle.list(),
  });

  const { data: technicians = [] } = useQuery({
    queryKey: ['technicians'],
    queryFn: () => base44.entities.Technician.list(),
  });

  // Subscribe to real-time updates
  useEffect(() => {
    const unsubVehicles = base44.entities.Vehicle.subscribe(() => {
      queryClient.invalidateQueries({ queryKey: ['vehicles'] });
    });
    const unsubTechs = base44.entities.Technician.subscribe(() => {
      queryClient.invalidateQueries({ queryKey: ['technicians'] });
    });
    
    return () => {
      unsubVehicles();
      unsubTechs();
    };
  }, [queryClient]);

  const deleteTechnicianMutation = useMutation({
    mutationFn: (id) => base44.entities.Technician.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['technicians'] });
      setSelectedTechnician(null);
    },
  });

  const handleAuthorClick = (authorName) => {
    const tech = technicians.find(t => t.name === authorName);
    if (tech) setSelectedTechnician(tech);
  };

  const handleVehicleClick = (vehicleId) => {
    navigate(createPageUrl('VehiclesInProduction') + '?vehicleId=' + vehicleId);
  };

  const filteredVehicles = vehicles.filter(v => v.current_process === processFilter);

  return (
    <div className="flex min-h-screen bg-[#F3F1FE]/30">
      <Sidebar currentPage="Dashboard" />
      
      <div className="flex-1 p-4 md:p-6 overflow-x-hidden">
        <div className="mb-6 flex items-center justify-between">
          <div>
            <h1 className="text-xl md:text-2xl font-bold text-slate-900">Dashboard</h1>
            <p className="text-xs md:text-sm text-slate-500">Real-time assembly monitoring dashboard</p>
          </div>
          <Button
            onClick={() => setShowPassdownModal(true)}
            className="bg-[#9F8DFB] hover:bg-[#8B7FE8]"
          >
            <FileText className="w-4 h-4 mr-2" />
            Generate Passdown
          </Button>
        </div>

        {/* Bay Map */}
        <IntegrativeBayMap 
          vehicles={vehicles}
          onVehicleClick={handleVehicleClick}
        />

        {/* Process Filter Tabs */}
        <div className="mt-6">
          <Tabs value={processFilter} onValueChange={setProcessFilter} className="w-full">
            <TabsList className="flex flex-nowrap md:grid md:grid-cols-5 w-full bg-transparent border-b border-slate-200 rounded-none h-auto p-0 overflow-x-auto md:overflow-x-visible gap-0">
              <TabsTrigger 
                value="disassembling" 
                className="text-xs md:text-sm font-medium data-[state=active]:bg-transparent data-[state=active]:text-[#9B8CFF] data-[state=active]:border-b-2 data-[state=active]:border-[#9B8CFF] rounded-none px-3 md:px-4 py-3 whitespace-nowrap"
              >
                DISASSEMBLING
              </TabsTrigger>
              <TabsTrigger 
                value="assembling" 
                className="text-xs md:text-sm font-medium data-[state=active]:bg-transparent data-[state=active]:text-[#9B8CFF] data-[state=active]:border-b-2 data-[state=active]:border-[#9B8CFF] rounded-none px-3 md:px-4 py-3 whitespace-nowrap"
              >
                ASSEMBLING
              </TabsTrigger>
              <TabsTrigger 
                value="quality_check" 
                className="text-xs md:text-sm font-medium data-[state=active]:bg-transparent data-[state=active]:text-[#9B8CFF] data-[state=active]:border-b-2 data-[state=active]:border-[#9B8CFF] rounded-none px-3 md:px-4 py-3 whitespace-nowrap"
              >
                QUALITY CHECK
              </TabsTrigger>
              <TabsTrigger 
                value="launching_system" 
                className="text-xs md:text-sm font-medium data-[state=active]:bg-transparent data-[state=active]:text-[#9B8CFF] data-[state=active]:border-b-2 data-[state=active]:border-[#9B8CFF] rounded-none px-3 md:px-4 py-3 whitespace-nowrap"
              >
                LAUNCHING SYSTEM
              </TabsTrigger>
              <TabsTrigger 
                value="acceptance_check" 
                className="text-xs md:text-sm font-medium data-[state=active]:bg-transparent data-[state=active]:text-[#9B8CFF] data-[state=active]:border-b-2 data-[state=active]:border-[#9B8CFF] rounded-none px-3 md:px-4 py-3 whitespace-nowrap"
              >
                ACCEPTANCE CHECK
              </TabsTrigger>
            </TabsList>

            <TabsContent value="disassembling" className="mt-4">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {filteredVehicles.map(vehicle => (
                  <div 
                    key={vehicle.id}
                    onClick={() => handleVehicleClick(vehicle.id)}
                    className="bg-white rounded-lg border border-slate-200 p-4 cursor-pointer hover:shadow-md transition-shadow"
                  >
                    <h3 className="font-semibold text-slate-900">{vehicle.model}</h3>
                    <p className="text-xs text-slate-500 mt-1">VIN: {vehicle.vin}</p>
                    <div className="mt-2 flex items-center gap-2">
                      <div className="text-xs text-slate-600">
                        Bay {vehicle.location?.replace('bay_', '') || 'N/A'}
                      </div>
                      <div className="text-xs text-slate-600">
                        • {vehicle.completion_percentage || 0}% Complete
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </TabsContent>

            <TabsContent value="assembling" className="mt-4">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {filteredVehicles.map(vehicle => (
                  <div 
                    key={vehicle.id}
                    onClick={() => handleVehicleClick(vehicle.id)}
                    className="bg-white rounded-lg border border-slate-200 p-4 cursor-pointer hover:shadow-md transition-shadow"
                  >
                    <h3 className="font-semibold text-slate-900">{vehicle.model}</h3>
                    <p className="text-xs text-slate-500 mt-1">VIN: {vehicle.vin}</p>
                    <div className="mt-2 flex items-center gap-2">
                      <div className="text-xs text-slate-600">
                        Bay {vehicle.location?.replace('bay_', '') || 'N/A'}
                      </div>
                      <div className="text-xs text-slate-600">
                        • {vehicle.completion_percentage || 0}% Complete
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </TabsContent>

            <TabsContent value="quality_check" className="mt-4">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {filteredVehicles.map(vehicle => (
                  <div 
                    key={vehicle.id}
                    onClick={() => handleVehicleClick(vehicle.id)}
                    className="bg-white rounded-lg border border-slate-200 p-4 cursor-pointer hover:shadow-md transition-shadow"
                  >
                    <h3 className="font-semibold text-slate-900">{vehicle.model}</h3>
                    <p className="text-xs text-slate-500 mt-1">VIN: {vehicle.vin}</p>
                    <div className="mt-2 flex items-center gap-2">
                      <div className="text-xs text-slate-600">
                        Bay {vehicle.location?.replace('bay_', '') || 'N/A'}
                      </div>
                      <div className="text-xs text-slate-600">
                        • {vehicle.completion_percentage || 0}% Complete
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </TabsContent>

            <TabsContent value="launching_system" className="mt-4">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {filteredVehicles.map(vehicle => (
                  <div 
                    key={vehicle.id}
                    onClick={() => handleVehicleClick(vehicle.id)}
                    className="bg-white rounded-lg border border-slate-200 p-4 cursor-pointer hover:shadow-md transition-shadow"
                  >
                    <h3 className="font-semibold text-slate-900">{vehicle.model}</h3>
                    <p className="text-xs text-slate-500 mt-1">VIN: {vehicle.vin}</p>
                    <div className="mt-2 flex items-center gap-2">
                      <div className="text-xs text-slate-600">
                        Bay {vehicle.location?.replace('bay_', '') || 'N/A'}
                      </div>
                      <div className="text-xs text-slate-600">
                        • {vehicle.completion_percentage || 0}% Complete
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </TabsContent>

            <TabsContent value="acceptance_check" className="mt-4">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {filteredVehicles.map(vehicle => (
                  <div 
                    key={vehicle.id}
                    onClick={() => handleVehicleClick(vehicle.id)}
                    className="bg-white rounded-lg border border-slate-200 p-4 cursor-pointer hover:shadow-md transition-shadow"
                  >
                    <h3 className="font-semibold text-slate-900">{vehicle.model}</h3>
                    <p className="text-xs text-slate-500 mt-1">VIN: {vehicle.vin}</p>
                    <div className="mt-2 flex items-center gap-2">
                      <div className="text-xs text-slate-600">
                        Bay {vehicle.location?.replace('bay_', '') || 'N/A'}
                      </div>
                      <div className="text-xs text-slate-600">
                        • {vehicle.completion_percentage || 0}% Complete
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </TabsContent>
          </Tabs>
        </div>
      </div>

      {selectedTechnician && (
        <TechnicianDetail
          technician={selectedTechnician}
          onClose={() => setSelectedTechnician(null)}
          onDelete={(id) => deleteTechnicianMutation.mutate(id)}
        />
      )}

      <PassdownReportModal
        open={showPassdownModal}
        onClose={() => setShowPassdownModal(false)}
      />
    </div>
  );
}
